<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Capacitación en R y herramientas de productividad</title>
    <meta charset="utf-8" />
    <meta name="author" content="" />
    <meta name="date" content="2020-11-17" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




class: center, middle

.linea-superior[]
.linea-inferior[]


&lt;img src="imagenes/logo_portada2.png" width="200" /&gt;


## Capacitación en R y herramientas de productividad

## Proyecto Estratégico Servicios Compartidos para la Producción Estadística

## Visualización con ggplot2

### Noviembre 2020

.center[
Klaus Lehmann, Ignacio Agloni y Juan Medrano
]





---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Contenidos de hoy

- Conceptos básicos de visualización

--

- Elementos básicos de ggplot  



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La importancia de la visualización

La visualización juega un rol importante en las etapas del análisis de datos:

- Exploración

- Modelamiento

- Comunicación

--

*"The simple graph has brought more information to the data analyst's mind than any other device."* - [John Tukey](https://es.wikipedia.org/wiki/John_W._Tukey)



--

**Los gráficos nos permiten comunicar y atraer la atención de una audiencia**: [The Joy of Stats](https://www.youtube.com/watch?v=V8lbiiTF2P0)

???
Los principales objetivos de los gráficos en estadística son: 
i) facilitar comparaciones
ii) identificar tendencias

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La importancia de la visualización

## [John Snow](https://es.wikipedia.org/wiki/John_Snow) es considerado el padre de la epidemiología 

&lt;img src="imagenes/snow.png" width="800" /&gt;



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La importancia de la visualización

## [Matejka &amp; Fitzmaurice, 2017](https://www.autodeskresearch.com/publications/samestats) 

.center[
&lt;img src="https://raw.githubusercontent.com/rweekly/image/master/2017-03/AllDinosGrey_1_scale.png" width="700" /&gt;
]



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualizaciones no efectivas


.center[
&lt;img src="https://pbs.twimg.com/media/DXrZuSfX0AEjqtM.jpg" width="650" /&gt;
]



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualizaciones no efectivas

.center[
&lt;img src="imagenes/obamacare.PNG" width="800" /&gt;
]


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualizaciones no efectivas

![](http://3.bp.blogspot.com/-91nBt0UagvM/VMd0gEHuicI/AAAAAAAAKcw/XNyCOWp_JFI/s1600/pie1.jpg)

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualización efectiva

## Variables para mostrar atributos (Ward, Grinstein &amp; Keim, 2015, Interactive Data Visualization)


- Posición
- Marca
- Tamaño
- Brillo
- Color
- Orientación
- Textura
- Movimiento
- Efecto de las variables visuales

--

## No es aconsejable incluir demasiados atributos en una misma visualización


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%


# Visualización efectiva

Los gráficos requieren de nuestra capacidad visual para interpretar figuras geométricas.

--

[Cleveland &amp; McGuill (1985)](http://webspace.ship.edu/pgmarr/Geo441/Readings/Cleveland%20and%20McGill%201985%20-%20Graphical%20Perception%20and%20Graphical%20Methods%20for%20Analyzing%20Scientific%20Data.pdf)

- Las mejores visualizaciones son aquellas que requieren el uso de la "visión instantánea".

- Y no requieren de un esfuerzo visual para ser comprendidas.

--

.center[La "visión instantánea" nos permite evaluar visualmente **patrones geométricos** y dimensionar **magnitudes**]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualización efectiva

Cleveland ordena la dificultad de los elementos gráficos basado en la percepción para estimar variables cuantitativas.

--

De menor a mayor dificultad:

- **Posición** a lo largo de una escala común
- **Posición** en escalas no alineadas pero idénticas
- Longitud
- Ángulo o pendiente
- Área
- Saturación del color
- Tono del color


---



background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%


# Visualización efectiva

&lt;img src="imagenes/clplot.png" width="700px" height="290px" style="display: block; margin: auto;" /&gt;

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Visualización efectiva

## Las tortas son para comer...

--

## [*Three reasons that pie charts suck*](https://www.richardhollins.com/blog/why-pie-charts-suck/)

.pull-left[

1. Son malos para comunicar lo básico, a menos que tengan etiquetas.

2. No son buenos para mostrar tendencias (aun cuando lo acompañen etiquetas).

3. No sirven para mostrar tendencias cuando se utilizan valores absolutos.
]

.pull-right[![](https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/Piecharts.svg/2000px-Piecharts.svg.png)
]

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Receta para hacer ~~malos~~ gráficos

- Confunde a los demás respecto a lo que quieres mostrar (con etiquetas que no explican nada o características que no agregan información).

--

- Incluye muchos atributos (posición, color, tamaño, textura, forma)

--

- Usa un gráfico de torta (con efectos 3d).

--

- Incluye más de una escala en un mismo gráfico

--

- Si comparas más de un gráfico, ojalá utiliza distintas escalas.

--

.center[
&lt;img src="https://media.giphy.com/media/eJX4NrE7T9yhgvqXKX/giphy.gif" width="400" /&gt;
]





---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo

## A partir de los conceptos revisados, ¿qué podemos decir de esta visualización?

.center[
&lt;img src="imagenes/babyboomers.PNG" width="600" /&gt;
]


---
.linea-superior[]
.linea-inferior[]


.center[
## Ahora que ya manejamos algunos conceptos, podemos pasar a `R`


&lt;img src="https://media.giphy.com/media/b5LTssxCLpvVe/giphy.gif" width="750" /&gt;
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Descripción del dataset 

Trabajaremos con un dataset de nombres inscritos en el registro civil

--

Los datos se encuentran en el paquete guaguas de [Riva Quiroga](https://github.com/rivaquiroga/guaguas)

.center[
&lt;img src="https://raw.githubusercontent.com/rivaquiroga/guaguas/master/man/figures/guaguas-hex.png" width="100" /&gt;
]

--



```r
#install.packages("guaguas")
library(guaguas)
head(guaguas, 2)
```

```
## # A tibble: 2 x 5
##    anio sexo  nombre     n proporcion
##   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;      &lt;dbl&gt;
## 1  1920 F     María   2128     0.105 
## 2  1920 M     José     982     0.0482
```

--

### Generemos un gráfico de barras con la cantidad de mujeres y hombres


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Gráficos en R 

R base ofrece herramientas de visualización

--





```r
plot(pressure)
```

&lt;img src="sesion_4_ggplot_files/figure-html/pressure-1.png" style="display: block; margin: auto;" /&gt;

--

Entonces, ¿por qué utilizar ggplot? 

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Gráficos en R 


`ggplot2` sigue una sintaxis coherente, lo que facilita su aprendizaje



```r
library(ggplot2)
ggplot(data = pressure) + 
          geom_point(mapping = aes(x = temperature, y = pressure))
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-3-1.png" style="display: block; margin: auto;" /&gt;

--

`ggplot2` se ha convertido en el estándar para la visualización en R

Estilo sobrio y elegante

Hay librerías en python que usan el diseño de ggplot 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Volvamos a nuestros datos

Queremos un gráfico de barras que nos muestre cantidad de nombres por sexo

Echaremos mano a lo aprendido en sesiones anteriores

--


```r
library(tidyverse)
tabla &lt;- guaguas %&gt;% 
  group_by(sexo) %&gt;% 
  summarise(suma = sum(n))

tabla
```

```
## # A tibble: 2 x 2
##   sexo      suma
##   &lt;chr&gt;    &lt;int&gt;
## 1 F      9805797
## 2 M     10431707
```


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La sintaxis de ggplot

`ggplot` funciona con un sistema de capas

Siempre comenzaremos con la función ggplot

--


```r
ggplot(data = tabla, aes(x = sexo, y = suma)) 
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-5-1.png" style="display: block; margin: auto;" /&gt;
--

* `data`: tabla para la cual queremos generar el gráfico

* `aes`: viene de *aesthetics*. Contiene los elementos estéticos de nuestro gráfico

    + `x`: variable que será mapeada al eje x 
    + `y`: variable que será mapeada al eje y

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La sintaxis de ggplot



```r
options(scipen = "999")
ggplot(data = tabla, aes(x = sexo, y = suma)) + 
* geom_bar(stat = "identity")
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;

--

- `geom_bar`: capa de figura geométrica 

- *identity*: le dice a ggplot que no queremos hacer nada con los datos, es decir, graficar la tabla sin modificaciones 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# ¿Qué es exactamente identity?

.center[
&lt;img src="https://media.giphy.com/media/a5viI92PAF89q/giphy.gif" width="200" /&gt;
]

--

`geom_bar` por defecto llama a la función `stat_count`

`stat_count` espera como input una sola variable 



```r
ggplot(data = tabla, aes(x = sexo, y = suma)) + 
  geom_bar()
```

```
## Error: stat_count() can only have an x or y aesthetic.
```

![](sesion_4_ggplot_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco más sobre identity

Las 2 barras tienen la misma altura

¿Qué creen que está pasando acá?


```r
ggplot(data = tabla, aes(x = sexo)) + 
  geom_bar()
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-8-1.png" style="display: block; margin: auto;" /&gt;

--

El problema es que nuestra base de datos no está ordenada de ese modo


```r
guaguas %&gt;% 
  filter(nombre == "Juan" &amp; anio == 2010)
```

```
## # A tibble: 1 x 5
*##    anio sexo  nombre     n proporcion
##   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;      &lt;dbl&gt;
*## 1  2010 M     Juan    1707    0.00650
```


Tenemos para cada nombre un conteo. Ejemplo: María, 300  


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# La sintaxis de ggplot

Agreguemos una segunda capa


```r
ggplot(data = tabla, aes(x = sexo, y = suma)) + 
  geom_bar(stat = "identity") + 
* geom_hline(aes(yintercept = mean(suma)) )
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-10-1.png" style="display: block; margin: auto;" /&gt;

--

- `geom_hline`: línea horizontal 


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicio rápido

Creemos un gráfico de líneas que contenga la suma de guaguas inscritas para cada año

*Pista*: la capa para crear un gráfico de líneas es `geom_line` 

--


```r
guaguas %&gt;% 
  group_by(anio) %&gt;% 
  summarise(suma = sum(n)) %&gt;% 
  ggplot(aes(x = anio, y = suma)) +
* geom_line()
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-11-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Agregando más atributos

Nombres de mujer más populares de 2019


```r
top10 &lt;- guaguas %&gt;% 
  filter(anio == 2019 &amp; sexo == "F") %&gt;% 
  group_by(sexo) %&gt;% 
  arrange(desc(n)) %&gt;% 
  slice(1:10)
*ggplot(top10, aes(x = nombre, y = n, fill = nombre)) +
  geom_bar(stat = "identity")
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-12-1.png" style="display: block; margin: auto;" /&gt;


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Agregando más atributos

Para ordenar de mayor a menor, puedo usar `fct_reorder`


```r
top10 &lt;- guaguas %&gt;% 
  filter(anio == 2019 &amp; sexo == "F") %&gt;% 
  group_by(sexo) %&gt;% 
  arrange(desc(n)) %&gt;% 
  slice(1:10)
*ggplot(top10, aes(x = fct_reorder(nombre, desc(n)) , y = n, fill = nombre)) +
  geom_bar(stat = "identity")
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;




---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Agregando más atributos

Pueden manejar el color con el parámetro [color](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf) 

Con la función `labs` podemos agregar etiquetas a nuestro gráfico



```r
guaguas %&gt;% 
  filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
* ggplot(aes(x = anio, y = n, color = "coral")) +
  geom_line() +
  geom_vline(xintercept = 1971, linetype="dashed") +
* labs(title="El nombre Salvador a lo largo de la historia",
*       x ="año", y = "frecuencia")
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Agregando más atributos

La función `theme` controla características generales del gráfico: fuente, posición, tamaño de letra, etc. 



```r
guaguas %&gt;% 
  filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
  ggplot(aes(x = anio, y = n, color = "coral")) +
  geom_line() +
  geom_vline(xintercept = 1971, linetype="dashed") +
  labs(title="El nombre Salvador a lo largo de la historia", 
        x ="año", y = "frecuencia") + 
* theme(plot.title = element_text(hjust = 0.5))
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-15-1.png" style="display: block; margin: auto;" /&gt;



---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Un poco más sobre theme

Existen variables internas que nos permiten acceder a los elementos del gráfico

--

Con `element_text` podemos modificar varias cosas

.pull-left[


.small[

```r
guaguas::guaguas %&gt;% 
  filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
  ggplot(aes(x = anio, y = n, color = "coral")) +
  geom_line() +
  geom_vline(xintercept = 1971, linetype="dashed") +
  labs(title="El nombre Salvador a lo largo de la historia",
        x ="año", y = "frecuencia") + 
* theme(plot.title = element_text(hjust = 0.5),
*       axis.text.x = element_text(angle = 90))
```
]

]

.pull-right[
![](sesion_4_ggplot_files/figure-html/plot-label-out-1.png)&lt;!-- --&gt;
]


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%
  
# Un poco más sobre theme

.pull-left[
.small[

```r
guaguas %&gt;% 
  filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
  ggplot(aes(x = anio, y = n, color = "coral")) +
  geom_line() +
  geom_vline(xintercept = 1971, linetype="dashed") +
  labs(title="El nombre Salvador a lo largo de la historia",
      x ="año", y = "frecuencia") + 
  theme(plot.title = element_text(hjust = 0.5), 
       axis.text.x = element_text(angle = 90),
*      axis.title.x = element_text(color = "red"))
```
]
]

.pull-right[
![](sesion_4_ggplot_files/figure-html/plot-label2-out-1.png)&lt;!-- --&gt;
]


Con `color` manejamos el color del texto

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%
  
# Un poco más sobre theme

.pull-left[
.small[

```r
guaguas %&gt;% 
  filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
  ggplot(aes(x = anio, y = n, color = "coral")) +
  geom_line() +
  geom_vline(xintercept = 1971, linetype="dashed") +
  labs(title="El nombre Salvador a lo largo de la historia",
       x ="año", y = "frecuencia") + 
  theme(plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90),
        axis.title.x = element_text(color = "red"),
*       axis.text.y = element_text(face = "bold.italic"))
```
]
]


.pull-right[
![](sesion_4_ggplot_files/figure-html/plot-label3-out-1.png)&lt;!-- --&gt;
]

Con `face` manejamos el tipo de letra (plain, italic, bold o bold.italic)


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%
  
# Un poco más sobre theme

.pull-left[
.small[

```r
  guaguas %&gt;% 
    filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
    ggplot(aes(x = anio, y = n, color = "coral")) +
    geom_line() +
    geom_vline(xintercept = 1971, linetype="dashed") +
    labs(title="El nombre Salvador a lo largo de la historia",
         x ="año", y = "frecuencia") + 
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text.x = element_text(angle = 90),
          axis.title.x = element_text(color = "red"),
          axis.text.y = element_text(face = "bold.italic"),
*         legend.position = "none")
```
  ]
]


.pull-right[
![](sesion_4_ggplot_files/figure-html/plot-label4-out-1.png)&lt;!-- --&gt;
]

Con `legend.position` manejamos la posición de la leyenda. En este caso decidimos sacarla con `none` 

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%
  
# Un poco más sobre theme

.pull-left[
.small[

```r
  guaguas %&gt;% 
    filter(nombre == "Salvador" &amp; anio &lt;= 1990) %&gt;% 
    ggplot(aes(x = anio, y = n, color = "coral")) +
    geom_line() +
    geom_vline(xintercept = 1971, linetype="dashed") +
    labs(title="El nombre Salvador a lo largo de la historia",
         x ="año", y = "frecuencia") + 
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text.x = element_text(angle = 90),
          axis.title.x = element_text(color = "red"),
          axis.text.y = element_text(face = "bold.italic"),
*         legend.position =  "bottom",
*         legend.background = element_rect(fill = "darkgray") )
```
  ]
]


.pull-right[
![](sesion_4_ggplot_files/figure-html/plot-label5-out-1.png)&lt;!-- --&gt;
]

Con `legend.background` manejamos el fondo de la leyenda. En este caso usamos `darkgray` 


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Agregando más atributos y capas


```r
guaguas %&gt;% 
  filter(nombre %in% c("Milenka", "Branco", "Salomé", "Jovanka") &amp; anio &gt; 1980) %&gt;% 
* ggplot(aes(anio, n, color = nombre)) +
* geom_point() +
  geom_line() +
  labs(x = "año", y = "total inscripciones",
       title = "Inscripciones de nombres de personajes de Romané") +
  theme(plot.title = element_text(hjust = 0.5)) 
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-16-1.png" style="display: block; margin: auto;" /&gt;


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Segundo dataset

Base de datos que contiene datos de PIB y esperanza de vida por país y quinquenio


```r
life &lt;-  gapminder::gapminder
head(life, 10)
```

```
## # A tibble: 10 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
```

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Segundo dataset

Veamos cuál es la relación entre ingreso y esperanza de vida 


```r
life &lt;-  gapminder::gapminder %&gt;% 
  filter(year == 2007)

ggplot(life, aes(x = lifeExp, y = log(gdpPercap)) ) + 
  geom_point()
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-18-1.png" style="display: block; margin: auto;" /&gt;

Aplicamos una transformación logarítmica para obtener una mejor visualización

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicio rápido

Agreguemos una variable para indicar el continente de cada país

*Pista*: la columna continent contiene esta información. El parámetro `color` puede ser de ayuda 

--


```r
ggplot(life, aes(x = lifeExp, y = log(gdpPercap), color = continent) ) + 
  geom_point()
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-19-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicio rápido

Agreguemos otra variable para indicar la población de cada país

*Pista*: El parámetro `size` puede ser de gran ayuda

--


```r
ggplot(life, aes(x = lifeExp, y = log(gdpPercap), color = continent, size = pop) ) + 
  geom_point() +
* scale_size(range = c(1, 7))
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-20-1.png" style="display: block; margin: auto;" /&gt;

--

Puede ser útil agregar la capa `scale_size` para manejar el tamaño de los círculos


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Problema: los puntos se superponen

* Tenemos, al menos, dos soluciones
    + Usar transparencia
    + Jitter


```r
ggplot(life, aes(x = lifeExp, y = log(gdpPercap), color = continent, size = pop) ) + 
* geom_point(alpha = 0.6) +
  scale_size(range = c(1, 5))
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-21-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Problema: los puntos se superponen

`geom_jitter` agrega un ruido aleatorio



```r
ggplot(life, aes(x = lifeExp, y = log(gdpPercap), color = continent, size = pop) ) + 
  geom_point() +
  geom_jitter(width = 0.5) +
  scale_size()
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Paneles separados

Con `facet_wrap` generamos un panel para cada categoría de la variable


```r
ggplot(life, aes(x = lifeExp, y = log(gdpPercap), color = continent, size = pop) ) + 
  geom_point() +
  scale_size(range = c(1, 5)) +
* facet_wrap(~continent)
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /&gt;


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicio rápido

Seleccionemos los años 1992, 1997, 2002, 2007 y generemos un gráfico con facetas para cada uno de dichos años

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicio rápido (respuesta)




```r
gapminder::gapminder %&gt;% 
  filter(year %in% c(1992, 1997, 2002, 2007)) %&gt;% 
  ggplot(aes(x = lifeExp, y = log(gdpPercap), color = continent, size = pop) ) + 
  geom_point() +
  scale_size(range = c(1, 7)) +
* facet_wrap(~year)
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-24-1.png" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Resumen

* Figuras revisadas en la clase
  + `geom_bar`
  + `geom_point`
  + `geom_line`
  + `geom_vline`
  + `geom_hline`

* Más figuras
  + `geom_text`
  + `geom_segment`
  + `geom_boxplot`
  + `geom_polygon`
  + `geom_density`

Memorizar las funciones es una mala estrategia para mejorar en ggplot 

--

Debemos preocuparnos de 2 cosas:

1. Entender la sintaxis de ggplot

2. Aprender a buscar rápidamente en internet lo que necesitamos

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# gganimate (bonus)

En nuestras visualizaciones la variable tiempo no se aprecia tan bien

Podemos incluir movimiento para mejorar la percepción de cómo cambia la relación entre pib y esperanza de vida a lo largo del tiempo



```r
#install.packages("gifski") puede ser necesario
library(gganimate)
p &lt;- ggplot(gapminder::gapminder, aes(gdpPercap, lifeExp, 
                           color = continent)) +
  geom_point(aes(size = pop), show.legend = FALSE) +
  scale_y_continuous(breaks = seq(20,90,10)) +
  scale_size(range = c(2,12)) + 
  scale_x_log10() +
* transition_states(year) +
* labs(title = 'Año: {closest_state}', x = 'pib p/c', y = 'esperanza de vida') +
  theme(plot.title = element_text(hjust = 0.5))
```

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# gganimate


```r
animate(p, renderer = gifski_renderer(), fps=10)
```

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-26-1.gif" style="display: block; margin: auto;" /&gt;

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

### Apliquemos todo lo aprendido a un caso concreto del INE 

--

La institución está transitando hacia sistemas automatizados de codificación

--

Ningún sistema es perfecto 

--

Típicamente, existe un porcentaje de error que debemos minimizar


.center[
&lt;img src="https://media.giphy.com/media/EizPK3InQbrNK/giphy.gif" width="300" /&gt;
]

--

Veamos el ejemplo de la CCIF

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

La EPF usa un clasificador llamado CCIF, que tiene más de 1.000 categorías

--

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-27-1.png" style="display: block; margin: auto;" /&gt;

--

.pull-left[

### ¿Cómo podemos mejorar el resultado?

]

.pull-right[
&lt;img src="https://media.giphy.com/media/3o7buirYcmV5nSwIRW/giphy.gif" width="180" /&gt;
]



---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

### Idea: Puedo codificar los registros difíciles a mano y dejarle los fáciles a mi sistema

.center[
&lt;img src="https://media.giphy.com/media/LrGHJGtTbT7PO/giphy.gif" width="400" /&gt;
]

--

### Estrategia mixta: parte automática y parte manual

---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

.center[
&lt;img src="imagenes/experimento.png" width="300" /&gt;
]


Receta:

- **paso 1:** Rankear los registros de mayor a menor dificultad

--

- **paso 2:** Elegir un punto de corte

--

- **paso 3:** Codificamos automáticamente solo lo que está sobre el punto de corte (más fáciles)

--

- **paso 4:** Calcular el error


---

background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-28-1.png" style="display: block; margin: auto;" /&gt;

### Si clasificamos el 5% a mano, mejoramos aproximadamente 3 pp

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejemplo INE

### ¿Cuál es el resultado a nivel de categoría?

--

&lt;img src="sesion_4_ggplot_files/figure-html/unnamed-chunk-29-1.gif" style="display: block; margin: auto;" /&gt;



---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Más ejemplos para motivar


.center[
&lt;img src="https://klauslehmann.netlify.app/img/inflacion.gif" width="800" /&gt;
]

[EPF-D3partitionR](https://klauslehmann.netlify.app/2019/07/07/en-qu%C3%A9-gastan-los-hogares-chilenos/)

[EPF-shiny](https://klaus-lehmann.shinyapps.io/epf-app/?_ga=2.98503452.206060216.1596836306-1258237829.1596836306)

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Más ejemplos para motivar


.center[
&lt;img src="imagenes/mapa_no_res.PNG" width="550" /&gt;
]


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Para seguir aprendiendo...

[Elegant Graphics for Data Analysis (Hadley Wickham)](https://ggplot2-book.org/index.html)

[Tutorial muy claro de ggplot](http://r-statistics.co/Complete-Ggplot2-Tutorial-Part1-With-R-Code.html)

[Tutorial y documentación de gganimate de los desarroladores](https://gganimate.com/)

[Mastering Shiny (Hadley Wickham)](https://mastering-shiny.org/index.html)


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Instrucciones generales

Trabajaremos con dos bases de datos: ene-2019-06.RData y con la base auditoria_ciuo.RData. La primera base corresponde al periodo mayo-junio-julio 2019 de la ENE, descargada desde el sitio web del INE; la segunda base contiene una muestra aleatoria de auditoría realizada al periodo por la Unidad de Nomenclaturas.
 
Podrán encontrar ambas bases de datos en nuestro canal de Generacion II en Teams, en la carpeta llamada "tarea final", dentro de el fichero "data", o pinchando en el siguiente link [poner hipervínculo a las bases de datos].
 
**importante**: la tarea puede ser desarrollada en grupos de 2 o 3 personas, o de forma individual, y debe ser entregada en rmarkdown (contenido a revisar en la última clase).
 
**Entrega: hasta el miércoles 2 de diciembre del 2020 - 23:59 hrs.**


---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicios


(1). Carga las bases ene-2019-06.RData y auditoria_ciuo.RData en tu entorno de trabajo (1 punto).

(2). Utilizando código, imprime la cantidad de observaciones (filas) y variables (columnas) que tiene cada una de las bases de datos, así como los nombres de las variables contenidas en cada una de ellas (1 punto).

(3). Tabule la cantidad de personas que contiene la base de datos según sexo y región en la base de datos ene-2019-06.RData (1 puntos).

(4). En la base ene-2019-06.RData se encuentra la variable llamada cae_especifico, que muestra la condición de actividad económica de las personas de 15 años o más. Esta variable muestra la condición de actividad económica con mucho detalle (tiene 28 categorías).

- A partir de cae_especifico genera la variable ocupados donde las personas ocupadas (categorías 1,2,3,4,5,6,7 de cae_específico) tengan el valor 1 y todo el resto de las personas tenga el valor 0.

- Tabula e imprime la variable ocupados por región (sin utilizar el factor de expansión; no es necesario que guardes la tabla en un objeto)

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicios

(5). La variable tramo_edad fue removida de la base de datos. Realiza las siguientes acciones (4 puntos):

- Vuelve a generar la variable tramo_edad a partir de la variable edad generando los siguientes tramos (en intervalos de 5 años):

.center[

Menores de 15 años&lt;br&gt;
15 a 19 años&lt;br&gt;
20 a 24 años&lt;br&gt;
25 a 29 años&lt;br&gt;
30 a 34 años&lt;br&gt;
35 a 39 años&lt;br&gt;
40 a 44 años&lt;br&gt;
45 a 49 años&lt;br&gt;
50 a 54 años&lt;br&gt;
55 a 59 años&lt;br&gt;
60 a 64 años&lt;br&gt;
65 a 69 años&lt;br&gt;
70 años o más&lt;br&gt;
]
---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicios

- Ahora, genera un tabulado (no es necesario que lo guardes en un objeto) que muestre la cantidad de personas en la muestra (sin usar los factores de expansión) según sexo y tramo de edad.

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicios

(6). En la ENE se consulta a quienes declaran encontrarse en búsqueda de empleo cual fue el día,(e5_dia) el mes (e5_mes) y el año (e5_ano) de su última búsqueda (5 puntos).

- Crea un objeto llamado "busqueda" donde solo se encuentren las observaciones que NO tienen valor missing en la variable e5.

- Selecciona para el objeto "busqueda" solo las variables que comienzan con "e5".

- Genera una variable con formato fecha, con el nombre "ultima_busqueda".

- Genera e imprime una tabla de resumen que muestre la fecha más atrás en el pasado (mínima), la más reciente (máxima) y la fecha media de última búsqueda de empleo. nota: se producen NAs en la variable "ultima_busqueda" por falta de información en algunas observaciones. Una alternativa para tratarlos es el argumento na.rm = TRUE.

---
background-image: url("imagenes/fondo2.PNG")
background-size: contain;
background-position: 100% 0%

# Ejercicios

(7). Ahora trabajaremos con la base de datos de auditoría del mismo periodo de la base ene-2019-06.RData. Esta base ya la cargaste en el ejercicio 1 (auditoria_ciuo.RData).

- la base auditoria_ciuo.RData (que en tu entorno se cargó en el objeto llamado "audit") genera una variable llamada "cambio" que sea 1 si

- Une la base ene-2019-06.RData (en el entorno se les cargó el objeto con nombre "ene") con la base auditoria_ciuo.RData (que en tu entorno se cargó en el objeto llamado "audit") manteniendo todos los registros de la base "ene" y solo las variables



---
class: center, middle

.linea-superior[]
.linea-inferior[]
&lt;img src="imagenes/logo_portada2.png" width="200" /&gt;


## Capacitación en R y herramientas de productividad

## Proyecto Estratégico Servicios Compartidos para la Producción Estadística

## Visualización con ggplot2

### Septiembre 2020
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
